import * as vscode from "vscode";
import * as path from "path";

import { getGlobalAI } from "../config/ai.js";
import {
  buildExistingPathsSummary,
  requestPathPlan,
  coerceGeneratedPaths,
} from "./generatePaths.js";

const FALLBACK_MODEL = "gpt-4.1-mini";

/**
 * Extract code content from an AI response.
 * If a fenced code block exists, return its inner content; otherwise return the raw text.
 */
export function extractCodeFromText(text) {
  if (!text) return "";
  const fenceMatch = text.match(/```[a-zA-Z0-9]*\n([\s\S]*?)```/);
  if (fenceMatch) return fenceMatch[1].replace(/\r?\n$/, "");
  return text;
}

/**
 * Ask AI to generate the full file content for a given relative file path.
 */
async function requestFileContent(model, instructions, existingPathsSummary, relativeFilePath) {
  const ext = path.extname(relativeFilePath).replace(/^\./, "");
  const systemPrompt = `à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢ AI à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œà¹‚à¸„à¹‰à¸”à¹à¸šà¸šà¸„à¸£à¸šà¸–à¹‰à¸§à¸™ à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ à¹à¸¥à¸°à¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™

à¸‚à¹‰à¸­à¸à¸³à¸«à¸™à¸”:
- à¹ƒà¸«à¹‰à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¹€à¸›à¹‡à¸™à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹„à¸Ÿà¸¥à¹Œà¹€à¸”à¸µà¸¢à¸§à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™à¸ªà¸³à¸«à¸£à¸±à¸š path à¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”
- à¹ƒà¸ªà¹ˆà¹‚à¸„à¹‰à¸”à¹€à¸•à¹‡à¸¡à¸—à¸±à¹‰à¸‡à¹„à¸Ÿà¸¥à¹Œ (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¹à¸„à¹ˆ snippet)
- à¸–à¹‰à¸²à¸£à¸¹à¹‰à¸ à¸²à¸©à¸²à¸ˆà¸²à¸à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥à¹„à¸Ÿà¸¥à¹Œ (.${ext || "unknown"}) à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸™à¸±à¹‰à¸™
- à¹„à¸¡à¹ˆà¹ƒà¸ªà¹ˆà¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¸­à¸·à¹ˆà¸™ à¹† à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¹‚à¸„à¹‰à¸”à¹ƒà¸™à¹€à¸­à¸²à¸•à¹Œà¸žà¸¸à¸•
- à¸«à¸²à¸à¹ƒà¸Šà¹‰à¹‚à¸„à¹‰à¸”à¸šà¸¥à¹‡à¸­à¸ à¹ƒà¸«à¹‰à¸«à¹ˆà¸­à¸”à¹‰à¸§à¸¢ \`\`\` à¹à¸¥à¸°à¸ à¸²à¸©à¸²à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸šà¸Šà¸™à¸´à¸”à¹„à¸Ÿà¸¥à¹Œ`;

  const userPrompt = `à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œà¸ªà¸³à¸«à¸£à¸±à¸š path: ${relativeFilePath}
à¸•à¸²à¸¡à¸‚à¹‰à¸­à¸à¸³à¸«à¸™à¸”à¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰: ${instructions}

à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸—à¸µà¹ˆà¸¡à¸µà¹ƒà¸™ workspace (à¸šà¸²à¸‡à¸ªà¹ˆà¸§à¸™):
- à¹„à¸”à¹€à¸£à¸à¸—à¸­à¸£à¸µ: ${existingPathsSummary.directories.slice(0, 20).join(", ")}${
    existingPathsSummary.directories.length > 20 ? "..." : ""
  }

à¹€à¸­à¸²à¸•à¹Œà¸žà¸¸à¸•à¹€à¸›à¹‡à¸™à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹„à¸Ÿà¸¥à¹Œà¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™`;

  try {
    const client = getGlobalAI();
    const response = await client.chat.completions.create({
      model: model,
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt },
      ],
      temperature: 0.1,
      max_tokens: 3500,
    });

    const content = response.choices?.[0]?.message?.content || "";
    return extractCodeFromText(content);
  } catch (error) {
    console.warn(`AI content generation failed for ${relativeFilePath}: ${error instanceof Error ? error.message : String(error)}`);
    // Fallback stub content
    const header = `// Auto-generated by AI for ${relativeFilePath}\n// Instruction: ${instructions}\n`;
    return header + "\n";
  }
}

async function ensureParentDir(uri) {
  const parent = vscode.Uri.joinPath(uri, "..");
  await vscode.workspace.fs.createDirectory(parent);
}

async function exists(uri) {
  try {
    await vscode.workspace.fs.stat(uri);
    return true;
  } catch {
    return false;
  }
}

/**
 * Main command: Create Project By AI
 * - Generates a set of file paths via AI (like generatePaths)
 * - Generates file contents for selected files
 * - Writes files to disk (skips existing by default)
 */
export async function createProjectByAI() {
  try {
    const workspaceFolders = vscode.workspace.workspaceFolders;
    if (!workspaceFolders || workspaceFolders.length === 0) {
      vscode.window.showErrorMessage("No workspace folder is open");
      return;
    }
    const workspaceFolder = workspaceFolders[0];

    const instructions = await vscode.window.showInputBox({
      prompt: "Describe the project/files you want to generate",
      placeHolder: "e.g., Next.js app with auth page, layout, and api route",
    });
    if (instructions === undefined) return;
    if (!instructions.trim()) {
      vscode.window.showWarningMessage("No instructions provided");
      return;
    }

    const config = vscode.workspace.getConfiguration();
    const model = config.get("ai.model") || FALLBACK_MODEL;

    const existingPathsSummary = await buildExistingPathsSummary(
      workspaceFolder,
      100
    );

    let responsePayload;
    await vscode.window.withProgress(
      {
        location: vscode.ProgressLocation.Notification,
        title: "Planning files to generate...",
        cancellable: false,
      },
      async (progress) => {
        progress.report({ increment: 0 });
        responsePayload = await requestPathPlan(
          model,
          instructions.trim(),
          existingPathsSummary
        );
        progress.report({ increment: 100 });
      }
    );

    const generated = coerceGeneratedPaths(responsePayload);
    const fileCandidates = generated.filter((g) => g.pathKind === "file");
    if (fileCandidates.length === 0) {
      vscode.window.showInformationMessage("No file paths proposed by AI.");
      return;
    }

    const quickPickItems = fileCandidates.map((item) => ({
      label: item.path,
      description: "ðŸ“„ File",
      picked: true,
      path: item.path,
    }));

    const selections = await vscode.window.showQuickPick(quickPickItems, {
      canPickMany: true,
      placeHolder: "Select files to generate",
    });
    if (!selections || selections.length === 0) {
      vscode.window.showInformationMessage("No files selected.");
      return;
    }

    const overwriteChoice = await vscode.window.showQuickPick(
      [
        { label: "Skip existing files", value: "skip" },
        { label: "Overwrite all existing files", value: "overwrite" },
      ],
      { placeHolder: "When a file already exists..." }
    );
    const overwriteAll = overwriteChoice?.value === "overwrite";

    const created = [];
    const skipped = [];
    const overwritten = [];
    const failures = [];

    await vscode.window.withProgress(
      {
        location: vscode.ProgressLocation.Notification,
        title: "Generating files...",
        cancellable: false,
      },
      async (progress) => {
        const total = selections.length;
        let done = 0;

        for (const sel of selections) {
          try {
            const target = vscode.Uri.joinPath(workspaceFolder.uri, sel.path);
            await ensureParentDir(target);

            const fileExists = await exists(target);
            if (fileExists && !overwriteAll) {
              skipped.push(sel.path);
              done += 1;
              progress.report({ increment: Math.floor((done / total) * 100) });
              continue;
            }

            const content = await requestFileContent(
              model,
              instructions.trim(),
              existingPathsSummary,
              sel.path
            );

            const buffer = Buffer.from(content, "utf8");
            await vscode.workspace.fs.writeFile(target, buffer);

            if (fileExists) overwritten.push(sel.path);
            else created.push(sel.path);

            done += 1;
            progress.report({ increment: Math.floor((done / total) * 100) });
          } catch (error) {
            failures.push({ path: sel.path, error: error instanceof Error ? error.message : String(error) });
          }
        }
      }
    );

    const parts = [];
    if (created.length) parts.push(`Created ${created.length}`);
    if (overwritten.length) parts.push(`Overwritten ${overwritten.length}`);
    if (skipped.length) parts.push(`Skipped ${skipped.length}`);
    const summary = parts.length ? parts.join(", ") : "No changes";

    if (failures.length) {
      const details = failures.map((f) => `${f.path}: ${f.error}`).join("\n");
      vscode.window.showErrorMessage(`Create Project By AI: ${summary}. Failed:\n${details}`);
    } else {
      vscode.window.showInformationMessage(`Create Project By AI: ${summary}.`);
    }
  } catch (error) {
    vscode.window.showErrorMessage(`Error: ${error instanceof Error ? error.message : String(error)}`);
  }
}

export default createProjectByAI;
