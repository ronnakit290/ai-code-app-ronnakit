<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'nonce-%NONCE%';" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prompt Content Editor</title>
  <style>
    body { margin: 0; font-family: sans-serif; color: var(--vscode-editor-foreground); background: var(--vscode-editor-background); }
    .wrapper { display: flex; flex-direction: column; height: 100vh; }
    .header { padding: 12px 16px; border-bottom: 1px solid var(--vscode-panel-border); }
    .header h1 { margin: 0; font-size: 14px; }
    .content { flex: 1; padding: 12px 16px; }
    textarea { width: 100%; height: 100%; box-sizing: border-box; resize: none; font-family: var(--vscode-editor-font-family, monospace); font-size: var(--vscode-editor-font-size, 13px); color: var(--vscode-input-foreground); background: var(--vscode-input-background); border: 1px solid var(--vscode-panel-border); border-radius: 4px; padding: 12px; }
    .footer { padding: 10px 16px; display: flex; justify-content: flex-end; gap: 8px; border-top: 1px solid var(--vscode-panel-border); }
    button { padding: 6px 16px; border-radius: 4px; border: 1px solid transparent; font-size: 13px; cursor: pointer; }
    button.save { background: var(--vscode-button-background); color: var(--vscode-button-foreground); }
    button.save:hover { background: var(--vscode-button-hoverBackground); }
    button.cancel { background: transparent; color: var(--vscode-button-secondaryForeground, var(--vscode-button-foreground)); border-color: var(--vscode-button-border, var(--vscode-panel-border)); }
  </style>
</head>
<body>
  <div class="wrapper">
    <header class="header">
      <h1 id="title">แก้ไข prompt template</h1>
    </header>
    <main class="content">
      <textarea id="editor" placeholder="พิมพ์ prompt ของคุณที่นี่"></textarea>
    </main>
    <footer class="footer">
      <button class="cancel" id="cancelBtn" type="button">Cancel</button>
      <button class="save" id="saveBtn" type="button">Save</button>
    </footer>
  </div>
  <script nonce="%NONCE%">
    const vscode = acquireVsCodeApi();
    // Decode base64 as UTF-8 to preserve non-ASCII characters
    function decodeBase64Utf8(b64) {
      const bin = atob(b64);
      const bytes = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
      return new TextDecoder('utf-8').decode(bytes);
    }
    const data = JSON.parse(decodeBase64Utf8('%INITIAL_DATA%'));
    const editor = document.getElementById('editor');
    const title = document.getElementById('title');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    title.textContent = data.instruction || 'แก้ไข prompt template';
    editor.value = data.initialContent || '';

    function postSave() {
      vscode.postMessage({ type: 'save', value: editor.value });
    }

    saveBtn.addEventListener('click', postSave);
    cancelBtn.addEventListener('click', () => vscode.postMessage({ type: 'cancel' }));
    window.addEventListener('keydown', (event) => {
      if ((event.ctrlKey || event.metaKey) && event.key === 's') {
        event.preventDefault();
        postSave();
      }
    });
    editor.focus();
  </script>
</body>
</html>
